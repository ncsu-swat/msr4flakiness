public void testSubmit() throws Exception {
    runTest("/v1/jobs", V1JobsServlet.class, IS_SECURITY_ENABLED, new Callable<Void>() {

        public Void call() throws Exception {
            MockDagEngineService.reset();
            String appPath = getFsTestCaseDir().toString() + "/app";
            FileSystem fs = getFileSystem();
            Path jobXmlPath = new Path(appPath, "workflow.xml");
            fs.create(jobXmlPath);
            int wfCount = MockDagEngineService.workflows.size();
            Configuration jobConf = new XConfiguration();
            jobConf.set(OozieClient.USER_NAME, getTestUser());
            jobConf.set(OozieClient.APP_PATH, appPath);
            Map<String, String> params = new HashMap<String, String>();
            URL url = createURL("", params);
            HttpURLConnection conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod("POST");
            conn.setRequestProperty("content-type", RestConstants.XML_CONTENT_TYPE);
            conn.setDoOutput(true);
            jobConf.writeXml(conn.getOutputStream());
            assertEquals(HttpServletResponse.SC_CREATED, conn.getResponseCode());
            JSONObject obj = (JSONObject) JSONValue.parse(new InputStreamReader(conn.getInputStream()));
            assertEquals(MockDagEngineService.JOB_ID + wfCount + MockDagEngineService.JOB_ID_END, obj.get(JsonTags.JOB_ID));
            assertFalse(MockDagEngineService.started.get(wfCount));
            wfCount++;
            jobConf = new XConfiguration();
            jobConf.set(OozieClient.USER_NAME, getTestUser());
            jobConf.set(OozieClient.APP_PATH, appPath);
            params = new HashMap<String, String>();
            params.put(RestConstants.ACTION_PARAM, RestConstants.JOB_ACTION_START);
            url = createURL("", params);
            conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod("POST");
            conn.setRequestProperty("content-type", RestConstants.XML_CONTENT_TYPE);
            conn.setDoOutput(true);
            jobConf.writeXml(conn.getOutputStream());
            assertEquals(HttpServletResponse.SC_CREATED, conn.getResponseCode());
            obj = (JSONObject) JSONValue.parse(new InputStreamReader(conn.getInputStream()));
            assertEquals(MockDagEngineService.JOB_ID + wfCount + MockDagEngineService.JOB_ID_END, obj.get(JsonTags.JOB_ID));
            assertTrue(MockDagEngineService.started.get(wfCount));
            Services services = Services.get();
            DagEngine de = services.get(DagEngineService.class).getDagEngine(getTestUser(), "undef");
            StringReader sr = new StringReader(de.getJob(MockDagEngineService.JOB_ID + wfCount).getConf());
            Configuration conf1 = new XConfiguration(sr);
            wfCount++;
            jobConf = new XConfiguration();
            jobConf.set(OozieClient.USER_NAME, getTestUser());
            params = new HashMap<String, String>();
            url = createURL("", params);
            conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod("POST");
            conn.setRequestProperty("content-type", RestConstants.XML_CONTENT_TYPE);
            conn.setDoOutput(true);
            jobConf.writeXml(conn.getOutputStream());
            assertEquals(HttpServletResponse.SC_BAD_REQUEST, conn.getResponseCode());
            Path libPath1 = new Path(getFsTestCaseDir(), "libpath1");
            fs.mkdirs(libPath1);
            Path jobXmlPath1 = new Path(libPath1, "workflow.xml");
            fs.create(jobXmlPath1);
            jobConf = new XConfiguration();
            jobConf.set(OozieClient.USER_NAME, getTestUser());
            jobConf.set(OozieClient.LIBPATH, libPath1.toString());
            params = new HashMap<String, String>();
            url = createURL("", params);
            conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod("POST");
            conn.setRequestProperty("content-type", RestConstants.XML_CONTENT_TYPE);
            conn.setDoOutput(true);
            jobConf.writeXml(conn.getOutputStream());
            assertEquals(HttpServletResponse.SC_CREATED, conn.getResponseCode());
            assertEquals(HttpServletResponse.SC_CREATED, conn.getResponseCode());
            obj = (JSONObject) JSONValue.parse(new InputStreamReader(conn.getInputStream()));
            assertEquals(MockDagEngineService.JOB_ID + wfCount + MockDagEngineService.JOB_ID_END, obj.get(JsonTags.JOB_ID));
            assertFalse(MockDagEngineService.started.get(wfCount));
            wfCount++;
            Path libPath2 = new Path(getFsTestCaseDir(), "libpath2");
            fs.mkdirs(libPath2);
            jobConf = new XConfiguration();
            jobConf.set(OozieClient.USER_NAME, getTestUser());
            jobConf.set(OozieClient.LIBPATH, libPath1.toString() + "," + libPath2.toString());
            params = new HashMap<String, String>();
            url = createURL("", params);
            conn = (HttpURLConnection) url.openConnection();
            conn.setRequestMethod("POST");
            conn.setRequestProperty("content-type", RestConstants.XML_CONTENT_TYPE);
            conn.setDoOutput(true);
            jobConf.writeXml(conn.getOutputStream());
            assertEquals(HttpServletResponse.SC_CREATED, conn.getResponseCode());
            assertEquals(HttpServletResponse.SC_CREATED, conn.getResponseCode());
            obj = (JSONObject) JSONValue.parse(new InputStreamReader(conn.getInputStream()));
            assertEquals(MockDagEngineService.JOB_ID + wfCount + MockDagEngineService.JOB_ID_END, obj.get(JsonTags.JOB_ID));
            assertFalse(MockDagEngineService.started.get(wfCount));
            wfCount++;
            return null;
        }
    });
}
